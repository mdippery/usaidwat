#!/usr/bin/env ruby

require 'usaidwat'
require 'usaidwat/utils'


VERSION = "usaidwat v#{USaidWat::VERSION}"
USAGE = "Usage: #{File.basename $0} <user> [<subreddit>]"

def die(code=1)
  $stderr.puts VERSION
  $stderr.puts USAGE
  exit code
end

die if ARGV.length < 1 or ARGV.length > 2

if ARGV.first == '--help' or ARGV.first == '-h'
  puts USAGE
  exit 0
end

if ARGV.first == '--version' or ARGV.first == '-V'
  puts VERSION
  exit 0
end

reddit_user = USaidWat::RedditUser.new ARGV.shift
if ARGV.length == 0
  comments = reddit_user.retrieve_comments
  exit 2 unless comments
  max_key = 1
  comments.each { |c| max_key = c.first.length if c.first.length > max_key }
  comments.each { |c| printf "%-*s  %s\n", max_key, c.first, c.last }
else
  subreddit = ARGV.shift
  comments = reddit_user.comments_for_subreddit subreddit
  is_first = true
  run_pager
  width = `tput cols`.to_i rescue 80
  comments.each do |c|
    puts '-' * width unless is_first
    puts c
    is_first = false
  end
end
