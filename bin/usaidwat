#!/usr/bin/env ruby

require 'usaidwat'
require 'usaidwat/commands'


def require_path(subcommand)
  "usaidwat/cmd/#{subcommand}"
end

def die(code=1)
  $stderr.puts "usaidwat v#{USaidWat::VERSION}"
  $stderr.puts "Usage: #{File.basename $0} <subcommand> [options]"
  $stderr.puts
  $stderr.puts "Available commands are:"
  commands = USaidWat.commands
  max_cmd = 0
  commands.each { |c| max_cmd = c.length if c.length > max_cmd }
  commands.each do |cmd|
    require require_path(cmd)
    help = "#{cmd}_tag".to_sym
    begin
      help = USaidWat::Commands.send help
      $stderr.printf "    %-*s  %s\n", max_cmd, cmd, help
    rescue NoMethodError
      # Skip it -- it's a "private" command
    end
  end
  exit code
end

die if ARGV.length < 1

subc = ARGV.shift
begin
  require require_path(subc)
  USaidWat::Commands.send subc.gsub('-', '_').to_sym
rescue LoadError
  $stderr.puts "usaidwat: command '#{subc}' not found"
  exit 2
end
